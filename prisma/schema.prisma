generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model detalle_mantenimiento {
  id_detalle         Int             @id @default(autoincrement())
  tipo_mantenimiento String          @db.VarChar(50)
  nombre_detalle     String          @db.VarChar(255)
  mantenimiento      mantenimiento[]
}

model mantenimiento {
  costomant             Float?
  detalle_id            Int?
  fechamant             DateTime?              @db.Date
  idmant                Int                    @id @default(autoincrement())
  idprop                Int?
  idres                 Int?
  idveh                 Int?
  descripcion           String?                @db.VarChar(255)
  detalle_mant          String?                @db.VarChar(255)
  fotomant              String?                @db.VarChar(255)
  otro_detalle          String?                @db.VarChar(255)
  tipomant              String?                @db.VarChar(255)
  vehiculo              vehiculo?              @relation(fields: [idveh], references: [idveh], onDelete: NoAction, onUpdate: NoAction, map: "fk2dk91k5354wh67qyeowvellkr")
  detalle_mantenimiento detalle_mantenimiento? @relation(fields: [detalle_id], references: [id_detalle], onDelete: NoAction, onUpdate: NoAction, map: "fkcmorx1ksf7bco8veasvfnaq87")
  reserva               reserva?               @relation(fields: [idres], references: [idres], onDelete: NoAction, onUpdate: NoAction, map: "fkdke8r86me481asmu7ygnov05t")
  usuario               usuario?               @relation(fields: [idprop], references: [idprop], onDelete: NoAction, onUpdate: NoAction, map: "fkis0owv6xp5ipmv21ki0mw1ah6")
}

model reserva {
  idres             Int             @id @default(autoincrement())
  fechares          DateTime?       @db.Timestamp(6)
  fechainicio       DateTime?       @db.Timestamp(6)
  fechafin          DateTime?       @db.Timestamp(6)
  costo             Int?
  fechafinalizacion DateTime?       @db.Timestamp(6)
  idcli             Int?
  idveh             Int?
  estado            EstadoReserva?  @default(PENDIENTE)
  
  // Campos de auditoría
  created_at        DateTime        @default(now())
  updated_at        DateTime        @default(now()) @updatedAt
  created_by        Int?
  updated_by        Int?
  
  // Relaciones
  mantenimiento     mantenimiento[]
  usuario           usuario?        @relation("ClienteReservas", fields: [idcli], references: [idprop], onDelete: NoAction, onUpdate: NoAction, map: "fkhcb7l9qoy85ndceeubthuid7g")
  vehiculo          vehiculo?       @relation(fields: [idveh], references: [idveh], onDelete: NoAction, onUpdate: NoAction, map: "fkj2yfy568nnvlnkxm9k7329j4s")
}

model usuario {
  idprop               Int                    @id @default(autoincrement())
  nomprop              String?                @db.VarChar(255)
  apeprop              String?                @db.VarChar(255)
  dniprop              String?                @db.VarChar(255)
  emailprop            String?                @unique @db.VarChar(255)
  password             String?                @db.VarChar(255)
  estprop              Boolean?
  telefonoprop         String?                @db.VarChar(20)
  rol                  String?                @db.VarChar(255)
  authUserId           String?                @unique
  
  // Campos de auditoría
  created_at           DateTime               @default(now())
  updated_at           DateTime               @default(now()) @updatedAt
  created_by           Int?
  updated_by           Int?
  
  // Relaciones existentes
  mantenimiento        mantenimiento[]
  reserva              reserva[]              @relation("ClienteReservas")
  user                 user?                  @relation(fields: [authUserId], references: [id])
  vehiculo             vehiculo[]
  vehiculos_eliminados vehiculos_eliminados[]
  
  // Nuevas relaciones de auditoría
  audit_logs           audit_log[]            // Logs de auditoría donde este usuario hizo cambios
  created_by_user      usuario?               @relation("UserCreatedBy", fields: [created_by], references: [idprop])
  updated_by_user      usuario?               @relation("UserUpdatedBy", fields: [updated_by], references: [idprop])
  users_created        usuario[]              @relation("UserCreatedBy")
  users_updated        usuario[]              @relation("UserUpdatedBy")
}

model vehiculo {
  idveh                  Int                    @id @default(autoincrement())
  plaveh                 String?                @db.VarChar(255)
  marveh                 String?                @db.VarChar(255)
  modveh                 String?                @unique @db.VarChar(255)
  anioveh                Int?
  categoria              String?                @db.VarChar(255)
  potencia               Float?
  capacidad              String?                @db.VarChar(255)
  dimensiones            String?                @db.VarChar(255)
  peso                   Float?
  accesorios             String?                @db.VarChar(500)
  requiere_certificacion Boolean?
  horas_uso              Float?
  precioalquilo          Float?
  fecharegistro          DateTime?              @db.Date
  fotoveh                String?
  idprop                 Int?
  estveh                 EstadoVehiculo?
  imagenUrl              String?
  
  // Campos de auditoría
  created_at             DateTime               @default(now())
  updated_at             DateTime               @default(now()) @updatedAt
  created_by             Int?
  updated_by             Int?
  
  // Relaciones existentes
  mantenimiento          mantenimiento[]
  reserva                reserva[]
  usuario                usuario?               @relation(fields: [idprop], references: [idprop], onDelete: NoAction, onUpdate: NoAction, map: "fk2pu1225mw666tkb93d0dhd49v")
  vehiculos_eliminados   vehiculos_eliminados[]
}

model vehiculos_eliminados {
  fecharegistro DateTime @db.Date
  id            Int      @id @default(autoincrement())
  idprop        Int
  idveh         Int
  razon         String   @db.VarChar(255)
  vehiculo      vehiculo @relation(fields: [idveh], references: [idveh], onDelete: NoAction, onUpdate: NoAction, map: "fkqy7dvq9g8rcrd4c0lmperqxcb")
  usuario       usuario  @relation(fields: [idprop], references: [idprop], onDelete: NoAction, onUpdate: NoAction, map: "fksanpo3lbpuvrt9yxfhec1hsqm")
}

model account {
  id                    String    @id
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  user                  user      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model session {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  user      user     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model user {
  id            String    @id
  name          String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  rol           String?   @db.VarChar(255)
  nomprop       String?   @db.VarChar(255)
  apeprop       String?   @db.VarChar(255)
  dniprop       String?   @db.VarChar(255)
  account       account[]
  session       session[]
  usuario       usuario?
}

model verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

enum EstadoVehiculo {
  DISPONIBLE
  OCUPADO
  EN_MANTENIMIENTO
  FUERA_SERVICIO
}

enum EstadoReserva {
  PENDIENTE
  CONFIRMADA
  RECHAZADA
  ESPERANDO_CLIENTE
  EN_USO
  ESPERANDO_PROPIETARIO
  FINALIZADA
  CANCELADA
}

enum Rol {
  PROPIETARIO
  CLIENTE
  ADMINISTRADOR
}

// ===== SISTEMA DE AUDITORÍA =====
model audit_log {
  id              Int      @id @default(autoincrement())
  tabla           String   @db.VarChar(50)          // Nombre de la tabla afectada
  registro_id     String   @db.VarChar(50)          // ID del registro afectado
  operacion       AuditAction                       // CREATE, UPDATE, DELETE
  datos_anteriores Json?                            // Datos antes del cambio (para UPDATE/DELETE)
  datos_nuevos     Json?                            // Datos después del cambio (para CREATE/UPDATE)
  usuario_id      Int?                              // ID del usuario que hizo el cambio
  usuario_email   String?  @db.VarChar(255)         // Email del usuario (backup)
  ip_address      String?  @db.VarChar(45)          // IP desde donde se hizo el cambio
  user_agent      String?  @db.Text                 // Navegador/aplicación usada
  fecha_cambio    DateTime @default(now())          // Timestamp del cambio
  sesion_id       String?  @db.VarChar(255)         // ID de sesión (opcional)
  comentario      String?  @db.Text                 // Comentario adicional
  
  // Relación con usuario (opcional)
  usuario         usuario? @relation(fields: [usuario_id], references: [idprop], onDelete: SetNull)
  
  @@index([tabla, registro_id])
  @@index([usuario_id])
  @@index([fecha_cambio])
  @@index([operacion])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  FAILED_LOGIN
}
